<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>ç©ºã®ã™ã”éŒ² - ãƒ•ãƒ©ã‚¤ãƒˆè»Œè·¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="summary.css" />
</head>

<body>
  <div id="summary-box">
    <div class="summary-block date-block date-nav">
      <button id="summary-button" onclick="summary_open_close()">â–²</button>
      <button onclick="shiftDate(-1)">â—€ï¸</button>
      <input class="date-input" type="date" id="log-date-picker" onchange="handleDateChange(this.value)" />
      <button onclick="shiftDate(1)">â–¶ï¸</button>
    </div>
  </div>

  <div id="map"></div>
  <script>
    mapboxgl.accessToken =
      "pk.eyJ1Ijoic2VlMzAwNTIiLCJhIjoiY2x3cnd1anQzMDFhazJqcHk0Ync3anU1YyJ9.ryhShR_VuA0ynE9d08duQw";

    const params = new URLSearchParams(location.search);
    const logDate = params.get("log") || "2025-04-21";
    const styleParam = (params.get("style") || "streets").toLowerCase();
    const centerParam = params.get("center")?.split(",").map(Number) || [
      135.5, 34.7,
    ];
    const zoomParam = parseFloat(params.get("zoom")) || 7;

    const geojsonUrl = `geojson/${logDate}.json`;

    const styleMap = {
      streets: "mapbox://styles/mapbox/streets-v11",
      dark: "mapbox://styles/mapbox/dark-v10",
      light: "mapbox://styles/mapbox/light-v10",
      satellite: "mapbox://styles/mapbox/satellite-streets-v12",
      custom: "mapbox://styles/see30052/cm9tb8jol00dr01sphqrf7hlh",
    };

    const mapStyle = styleMap[styleParam] || styleMap["custom"];

    const map = new mapboxgl.Map({
      container: "map",
      style: mapStyle,
      center: centerParam,
      zoom: zoomParam,
    });

    let flights = [];
    let movingPoints = [];
    let virtualTime = 0;
    let animationStarted = false;
    let startEpoch = 0;
    let endEpoch = 0;
    let speedMultiplier = 120; // ä»®æƒ³æ™‚é–“é€²ã¿æ–¹ï¼ˆä¾‹ï¼š60å€é€Ÿï¼ãƒªã‚¢ãƒ«1ç§’ã§ä»®æƒ³1åˆ†ï¼‰
    let virtualTimeDisplay = null;
    let pointsVisible = true;

    map.on("load", () => {
      fetch(geojsonUrl)
        .then((res) => res.json())
        .then((data) => {
          setupLines(data);
          setupFlights(data);
          setupMovingPoints();
          // ã“ã“ã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã ã‘ã«ã—ã¦ï¼Œæ™‚åˆ»ç¯„å›²ã®è¨­å®šã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã¯Summaryèª­ã¿è¾¼ã¿å¾Œã«è¡Œã†
        });
    });

    function setupLines(data) {
      map.addSource("trajectory", {
        type: "geojson",
        data: data,
      });
      map.addLayer({
        id: "trajectory-line",
        type: "line",
        source: "trajectory",
        paint: {
          "line-color": [
            "interpolate",
            ["linear"],
            ["get", "alt"],
            0, "#ff0000",
            10000, "#ffa500",
            20000, "#ffff00",
            30000, "#00ff00",
            40000, "#0000ff",
          ],
          "line-opacity": [
            "interpolate",
            ["linear"],
            ["get", "alt"],
            0, 0.3,
            40000, 0.05,
          ],
          "line-width": [
            "interpolate",
            ["linear"],
            ["get", "alt"],
            0, 2.0,
            40000, 0.8,
          ],
        },
      });

      // lineã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
      map.on('click', 'trajectory-line', (e) => {
        if (e.features.length > 0) {
          const flight = e.features[0].properties.flight || "ä¾¿åãªã—";
          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${flight}</strong>`)
            .addTo(map);
        }
      });
      map.on('mouseenter', 'trajectory-line', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'trajectory-line', () => {
        map.getCanvas().style.cursor = '';
      });
      // è¡¨ç¤ºé ˜åŸŸã‚’èª¿æ•´ã™ã‚‹
      const bounds = new mapboxgl.LngLatBounds();
      data.features.forEach((f) => {
        f.geometry.coordinates.forEach((coord) => bounds.extend(coord));
      });
      if (!params.has("center") && !params.has("zoom")) {
        map.fitBounds(bounds, { padding: 40 });
      }
    }

    function setupFlights(data) {
      flights = data.features.map((f) => ({
        coords: f.geometry.coordinates,
        timestamps: f.properties.timestamps
      }));
      // ä»®æƒ³æ™‚é–“ã‚’ãƒ‡ãƒ¼ã‚¿ä¸­ã®æœ€å°timestampã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
      // virtualTime = Math.min(...flights.flatMap(f => f.timestamps));
      // console.log("ã‚µãƒ³ãƒ—ãƒ« flight hex:", flights[0]);
      // console.log("ã‚µãƒ³ãƒ—ãƒ« flight timestamps[0]:", flights[0].timestamps[0]);
      // console.log("ISOå½¢å¼:", new Date(flights[0].timestamps[0] * 1000).toISOString());
    }

    function setupMovingPoints() {
      map.addSource("moving-points", {
        type: "geojson",
        data: {
          type: "FeatureCollection",
          features: []
        }
      });

      map.addLayer({
        id: "moving-points-layer",
        type: "circle",
        source: "moving-points",
        paint: {
          "circle-radius": 4,
          "circle-color": "#00ffff",
          "circle-opacity": 0.7,
        }
      });
    }

    // æ™‚åˆ»ç¯„å›²ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function setupTimeRange(dateStr) {
      const [yyyy, mm, dd] = dateStr.split("-").map(Number);
      startEpoch = Date.UTC(yyyy, mm - 1, dd - 1, 22, 0, 0) / 1000;  // å‰æ—¥22:00 UTC
      endEpoch = Date.UTC(yyyy, mm - 1, dd, 13, 0, 0) / 1000;         // å½“æ—¥13:00 UTC
      virtualTime = startEpoch;
      // console.log("æ™‚åˆ»ç¯„å›²:", startEpoch, endEpoch);
      // console.log("ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚åˆ»:", new Date(startEpoch * 1000).toISOString());
    }

    function animate() {
      if (!animationStarted) return;
      const source = map.getSource("moving-points");
      if (!source) {
        // console.warn("moving-points SourceãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ä¸­ã€‚");
        setTimeout(() => {
          requestAnimationFrame(animate);
        }, 200); // å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
        return;
      }

      virtualTime += speedMultiplier / 60; // ä»®æƒ³æ™‚é–“ã‚’é€Ÿåº¦å€ç‡ã«å¿œã˜ã¦é€²ã‚ã‚‹ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šï¼‰

      if (virtualTime >= endEpoch) {  // çµ‚äº†æ™‚åˆ»ã‚’è¶…ãˆãŸã‚‰ï¼Œæ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ«ãƒ¼ãƒ—
        virtualTime = startEpoch;
      }

      // ğŸ’¬ ä»®æƒ³æ™‚åˆ»ã‚’ç”»é¢ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
      const timeStr = new Date(virtualTime * 1000).toLocaleString("ja-JP", {
        // year: "numeric",
        // month: "2-digit",
        // day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
        timeZone: "Asia/Tokyo"
      }) + " (JST)";
      if (virtualTimeDisplay) {
        virtualTimeDisplay.textContent = timeStr;
      } else {
        const dom = document.getElementById("virtual-time");
        if (dom) {
          virtualTimeDisplay = dom;
          virtualTimeDisplay.textContent = timeStr;
        }
      }

      const activePoints = [];

      flights.forEach((flight) => {
        const coords = flight.coords;
        const timestamps = flight.timestamps;

        for (let i = 0; i < timestamps.length - 1; i++) {
          const t0 = timestamps[i];
          const t1 = timestamps[i + 1];

          if (virtualTime >= t0 && virtualTime < t1) {
            const ratio = (virtualTime - t0) / (t1 - t0);
            const lon = coords[i][0] + (coords[i + 1][0] - coords[i][0]) * ratio;
            const lat = coords[i][1] + (coords[i + 1][1] - coords[i][1]) * ratio;

            activePoints.push({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [lon, lat]
              }
            });
            break;
          }
        }
      });

      map.getSource("moving-points").setData({
        type: "FeatureCollection",
        features: activePoints
      });

      requestAnimationFrame(animate);
    }

    function startAnimation() {
      animationStarted = true;
      animate();
    }




    function getWeekdayLabel(dateStr) {
      const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const d = new Date(dateStr);
      return days[d.getDay()];
    }

    function formatHighlightFlights(text) {
      return text
        .split("\n")
        .map((line) => {
          const match = line.match(/^(\S+).*IKOMA\s+([\d:]+)/);
          if (match) {
            return `${match[1]}ï¼šIKOMAé€šéã€€${match[2]}`;
          } else {
            return line;
          }
        })
        .join("<br>");
    }


    function handleDateChange(value) {
      const yyyymmdd = value;
      const style = new URLSearchParams(location.search).get("style") || "dark";
      window.location.href = `?log=${yyyymmdd}&style=${style}&center=135.5,34.7&zoom=8.0`;
    }

    function shiftDate(offset) {
      const input = document.getElementById("log-date-picker");
      if (!input || !input.value) return;

      const current = new Date(input.value);
      current.setDate(current.getDate() + offset);

      const yyyy = current.getFullYear();
      const mm = String(current.getMonth() + 1).padStart(2, "0");
      const dd = String(current.getDate()).padStart(2, "0");
      const next = `${yyyy}-${mm}-${dd}`;

      const style = new URLSearchParams(location.search).get("style") || "dark";
      window.location.href = `?log=${next}&style=${style}&center=135.5,34.7&zoom=8.0`;
    }

    function animation_start_stop() {
      // console.log("ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹/åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸã€‚");
      const button = document.getElementById("toggle-animation");
      animationStarted = !animationStarted;
      button.textContent = animationStarted ? "â¸ï¸ Stop" : "â–¶ï¸ Play";
      if (animationStarted) animate();
    }

    function summary_open_close() {
      // console.log("Summaryãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸã€‚");
      const body  = document.getElementById("summary-closeable-box");
      const btn = document.getElementById("summary-button");
      if (body.style.display === "none") {
        body.style.display = "block";
        btn.textContent = "â–²";  // â†å±•é–‹ä¸­ã¯ä¸Šå‘ãä¸‰è§’
      } else {
        body.style.display = "none";
        btn.textContent = "â–¼";  // â†ãŸãŸã‚“ã§ã‚‹æ™‚ã¯ä¸‹å‘ãä¸‰è§’
      }
    }

    function points_show_hide() {
      console.log("ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸã€‚");
      pointsVisible = !pointsVisible;
      map.setLayoutProperty(
        "moving-points-layer",
        "visibility",
        pointsVisible ? "visible" : "none"
      );
      const togglePoints = document.getElementById("toggle-points");
      togglePoints.textContent = pointsVisible ? "ğŸ™ˆ Marker OFF" : "ğŸ‘€ Marker ON";
    }

    const summaryUrl = `summary/${logDate}.json`;
    fetch(summaryUrl)
      .then((res) => res.json())
      .then((summary) => {
        const box = document.getElementById("summary-box");
        const input = document.getElementById("log-date-picker"); // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã®è¦ç´ ã‚’å–å¾—
        if (input && summary.date) {
          input.value = summary.date;
          setupTimeRange(summary.date);   // æ™‚é–“ç¯„å›²ã‚’è¨­å®š
          startAnimation();               // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹  
        }

        box.innerHTML += `
            <div class="summary-block">
              <div class="icon">ğŸ•‘</div>
              <div class="text">
                <div class="label">
                  <span id="virtual-time">æ™‚åˆ»</span>
                  <button id="toggle-animation" class="animation-button" onclick="animation_start_stop()">â¸ï¸ Stop</button>
                  <button id="toggle-points" class="animation-button" onclick="points_show_hide()">ğŸ™ˆ No marker</button>
                </div>
              </div>
            </div>
            <div id="summary-closeable-box">
              <div class="summary-block">
                <div class="icon">âœˆï¸</div>
                <div class="text">
                  <div class="label">ç·ãƒ•ãƒ©ã‚¤ãƒˆè¨˜éŒ²æ•°</div>
                  <div class="value">${summary.flight_count}ä¾¿</div>
                </div>
              </div>

              <div class="summary-block">
                <div class="icon">ğŸ—ºï¸</div>
                <div class="text">
                  <div class="label">ç©ºè¦‹ã®ä¸˜å…¬åœ’(10nm)é€šé</div>
                  <div class="value">${summary.area_count2}ä¾¿</div>
                </div>
              </div>

              <div class="summary-block">
                <div class="icon">â›°ï¸</div>
                <div class="text">
                  <div class="label">ä¸€ç•ªé«˜ã„ã¨ã“ã‚ã‚’é£›ã‚“ã§ãŸã®ã¯</div>
                  <div class="value">${summary.max_flight}</b><span class="dim"> (${summary.max_altitude} ft)</div>
                </div>
              </div>

              <div class="summary-block">
                <div class="icon">ğŸŒŸ</div>
                <div class="text">
                  <div class="label">ä»Šæ—¥ã®æœ€çµ‚ä¾¿å¯¾æ±º</div>
                  <div class="value">ANA41ã®IKOMAé€šéï¼š${summary.focus_info.ANA41.ikoma}</div>
                  <div class="value">JAL139ã®IKOMAé€šéï¼š${summary.focus_info.JAL139.ikoma}</div>
                </div>
              </div>
            </div>
          `;
        setTimeout(() => {
          const input = document.getElementById("log-date-picker");
          if (input) {
            input.value = summary.date;
          }
        }, 100);
      })
      .catch((err) => {
        console.error("Summaryèª­ã¿è¾¼ã¿å¤±æ•—:", err);
        setTimeout(() => {
          const input = document.getElementById("log-date-picker");
          if (input) {
            input.value = logDate;  // summaryãŒãªã„å ´åˆã¯,urlã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆã€€
          }
        }, 100);
        const box = document.getElementById("summary-box");
        box.innerHTML += `
            <div class="summary-block">
              <div class="icon">ğŸ“¦</div>
              <div class="text">
                <div class="label">Summaryãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
              </div>
            </div>
          `;
      });
  </script>



</body>

</html>