<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>空のすご録 - フライト軌跡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
</head>

<body>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2VlMzAwNTIiLCJhIjoiY2x3cnd1anQzMDFhazJqcHk0Ync3anU1YyJ9.ryhShR_VuA0ynE9d08duQw';

    const params = new URLSearchParams(location.search);
    const logDate = params.get("log") || "20250418";
    const styleParam = (params.get("style") || "streets").toLowerCase();
    const centerParam = params.get("center")?.split(",").map(Number) || [135.5, 34.7];
    const zoomParam = parseFloat(params.get("zoom")) || 7;

    const geojsonUrl = `geojson/${logDate}.json`;

    const styleMap = {
      "streets": "mapbox://styles/mapbox/streets-v11",
      "dark": "mapbox://styles/mapbox/dark-v10",
      "light": "mapbox://styles/mapbox/light-v10",
      "satellite": "mapbox://styles/mapbox/satellite-streets-v12"
    };

    const mapStyle = styleMap[styleParam] || styleMap["streets"];

    const map = new mapboxgl.Map({
      container: "map",
      style: mapStyle,
      center: centerParam,
      zoom: zoomParam
    });

    map.on('load', () => {
      fetch(geojsonUrl)
        .then(res => res.json())
        .then(data => {
          map.addSource('trajectory', {
            type: 'geojson',
            data: data
          });
          map.addLayer({
            id: 'trajectory-line',
            type: 'line',
            source: 'trajectory',
            paint: {
              'line-color': [
                'interpolate', ['linear'], ['get', 'alt'],
                0, '#ff0000',
                10000, '#ffa500',
                20000, '#ffff00',
                30000, '#00ff00',
                40000, '#0000ff'
              ],
              'line-opacity': [
                'interpolate', ['linear'], ['get', 'alt'],
                0, 0.3,
                40000, 0.05
              ],
              'line-width': [
                'interpolate', ['linear'], ['get', 'alt'],
                0, 2.0,
                40000, 0.8
              ]
            }
          });

          const bounds = new mapboxgl.LngLatBounds();
          data.features.forEach(f => {
            f.geometry.coordinates.forEach(coord => bounds.extend(coord));
          });
          map.fitBounds(bounds, { padding: 40 });
        });
    });
  </script>
</body>

</html>
