<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>空のすご録 - フライト軌跡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="summary.css" />
  </head>

  <body>
    <div id="summary-box">📦 読み込み中...</div>

    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1Ijoic2VlMzAwNTIiLCJhIjoiY2x3cnd1anQzMDFhazJqcHk0Ync3anU1YyJ9.ryhShR_VuA0ynE9d08duQw";

      const params = new URLSearchParams(location.search);
      const logDate = params.get("log") || "2025-04-18";
      const styleParam = (params.get("style") || "streets").toLowerCase();
      const centerParam = params.get("center")?.split(",").map(Number) || [
        135.5, 34.7,
      ];
      const zoomParam = parseFloat(params.get("zoom")) || 7;

      const geojsonUrl = `geojson/${logDate}.json`;

      const styleMap = {
        streets: "mapbox://styles/mapbox/streets-v11",
        dark: "mapbox://styles/mapbox/dark-v10",
        light: "mapbox://styles/mapbox/light-v10",
        satellite: "mapbox://styles/mapbox/satellite-streets-v12",
      };

      const mapStyle = styleMap[styleParam] || styleMap["streets"];

      const map = new mapboxgl.Map({
        container: "map",
        style: mapStyle,
        center: centerParam,
        zoom: zoomParam,
      });

      map.on("load", () => {
        fetch(geojsonUrl)
          .then((res) => res.json())
          .then((data) => {
            map.addSource("trajectory", {
              type: "geojson",
              data: data,
            });
            map.addLayer({
              id: "trajectory-line",
              type: "line",
              source: "trajectory",
              paint: {
                "line-color": [
                  "interpolate",
                  ["linear"],
                  ["get", "alt"],
                  0,
                  "#ff0000",
                  10000,
                  "#ffa500",
                  20000,
                  "#ffff00",
                  30000,
                  "#00ff00",
                  40000,
                  "#0000ff",
                ],
                "line-opacity": [
                  "interpolate",
                  ["linear"],
                  ["get", "alt"],
                  0,
                  0.3,
                  40000,
                  0.05,
                ],
                "line-width": [
                  "interpolate",
                  ["linear"],
                  ["get", "alt"],
                  0,
                  2.0,
                  40000,
                  0.8,
                ],
              },
            });

            const bounds = new mapboxgl.LngLatBounds();
            data.features.forEach((f) => {
              f.geometry.coordinates.forEach((coord) => bounds.extend(coord));
            });
            // map.fitBounds(bounds, { padding: 40 });
            if (!params.has("center") && !params.has("zoom")) {
              map.fitBounds(bounds, { padding: 40 });
            }
          });
      });

      function getWeekdayLabel(dateStr) {
        const days = ["日", "月", "火", "水", "木", "金", "土"];
        const d = new Date(dateStr); // dateStr = "2025-04-21"
        return days[d.getDay()];
      }

      function formatHighlightFlights(text) {
        return text
          .split("\n")
          .map((line) => {
            const match = line.match(/^(\S+).*IKOMA\s+([\d:]+)/);
            if (match) {
              return `${match[1]}：IKOMA通過　${match[2]}`;
            } else {
              return line; // マッチしなかったらそのまま
            }
          })
          .join("<br>");
      }

      const summaryUrl = `summary/${logDate}.json`;
      fetch(summaryUrl)
        .then((res) => res.json())
        .then((summary) => {
          const box = document.getElementById("summary-box");
          box.innerHTML = `
            <div class="summary-block date-block">
              <div class="icon">📅</div>
              <input
                type="date"
                id="log-date-picker"
                value="${summary.date}"
                class="date-input"
              />
            </div>
            <div class="summary-block">
              <div class="icon">✈️</div>
              <div class="text">
                <div class="label">総フライト記録数</div>
                <div class="value">${summary.flight_count}便</div>
              </div>
            </div>

            <div class="summary-block">
              <div class="icon">🗺️</div>
              <div class="text">
                <div class="label">空見の丘公園(10nm)通過</div>
                <div class="value">${summary.area_count2}便</div>
              </div>
            </div>

            <div class="summary-block">
              <div class="icon">⛰️</div>
              <div class="text">
                <div class="label">一番高いところを飛んでたのは</div>
                <div class="value">${summary.max_flight}</b><span class="dim"> (${summary.max_altitude} ft)</div>
              </div>
            </div>

            <div class="summary-block">
              <div class="icon">⛰️</div>
              <div class="text">
                <div class="label">今日の最終便対決</div>
                <div class="value">${formatHighlightFlights(summary.highlight_flight)}</div>
              </div>
            </div>
          `;
          const dateInput = document.getElementById("log-date-picker");
          if (dateInput) {
            dateInput.value = summary.date;
          }
        })
        .then(() => {
          document
            .getElementById("log-date-picker")
            .addEventListener("change", (e) => {
              // const yyyymmdd = e.target.value.replaceAll("-", "");
              const yyyymmdd = e.target.value;
              const style =
                new URLSearchParams(location.search).get("style") || "dark";
              window.location.href = `?log=${yyyymmdd}&style=${style}&center=135.5,34.7&zoom=8.0`;
            });
        })
        .catch((err) => {
          document.getElementById("summary-box").innerText =
            "📦 summary 読み込み失敗";
          console.error("Summary読み込み失敗:", err);
        });
    </script>
  </body>
</html>
